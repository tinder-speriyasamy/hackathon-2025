# AI System Flow Diagrams

Visual representations of how the AI system works, from high-level architecture to detailed action flows.

---

## Table of Contents
1. [Complete System Flow](#complete-system-flow)
2. [Message Processing Flow](#message-processing-flow)
3. [Action Execution Flow](#action-execution-flow)
4. [Stage Transition Flow](#stage-transition-flow)
5. [State Management Flow](#state-management-flow)
6. [Specific Action Flows](#specific-action-flows)

---

## Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             USER                                     â”‚
â”‚                     (WhatsApp Message)                               â”‚
â”‚                                                                       â”‚
â”‚   Message: "I'm 24 years old"                                        â”‚
â”‚   From: whatsapp:+1234567890                                         â”‚
â”‚   ProfileName: "Sarah"                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Twilio Webhook
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SERVER.JS                                     â”‚
â”‚                    (Express Server)                                  â”‚
â”‚                                                                       â”‚
â”‚  POST /sms/receive                                                   â”‚
â”‚  â”œâ”€ Extract message, sender, media                                  â”‚
â”‚  â”œâ”€ Download media (if present) â†’ upload to R2                      â”‚
â”‚  â””â”€ Call aiMatchmaker.handleMessage()                               â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI MATCHMAKER                                     â”‚
â”‚                  (ai-matchmaker.js)                                  â”‚
â”‚                                                                       â”‚
â”‚  handleMessage(from, message, profileName, mediaUrls)               â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â”œâ”€ 1. Get/Create Session                                           â”‚
â”‚  â”‚    â”œâ”€ getPhoneMapping(phoneNumber) â†’ sessionId                   â”‚
â”‚  â”‚    â””â”€ getSessionData(sessionId) â†’ session                        â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â”œâ”€ 2. Store Media URLs (if present)                                â”‚
â”‚  â”‚    â”œâ”€ session.data.photos.push(...mediaUrls)                     â”‚
â”‚  â”‚    â””â”€ setSession(sessionId, session)                             â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â”œâ”€ 3. Generate AI Response                                         â”‚
â”‚  â”‚    â”‚                                                               â”‚
â”‚  â”‚    generateAIResponse(sessionId, message, phoneNumber)           â”‚
â”‚  â”‚    â”‚                                                               â”‚
â”‚  â”‚    â”œâ”€ A. Save User Message                                       â”‚
â”‚  â”‚    â”‚    â””â”€ session.messages.push({role:"user", content, sender}) â”‚
â”‚  â”‚    â”‚                                                               â”‚
â”‚  â”‚    â”œâ”€ B. Build Dynamic Prompt                                    â”‚
â”‚  â”‚    â”‚    â”œâ”€ Base Prompt (personality)                             â”‚
â”‚  â”‚    â”‚    â”œâ”€ Action Instructions (dynamic state)                   â”‚
â”‚  â”‚    â”‚    â”‚    â”œâ”€ Current stage                                    â”‚
â”‚  â”‚    â”‚    â”‚    â”œâ”€ Missing fields                                   â”‚
â”‚  â”‚    â”‚    â”‚    â”œâ”€ Uploaded photos                                  â”‚
â”‚  â”‚    â”‚    â”‚    â””â”€ Stage flow rules                                 â”‚
â”‚  â”‚    â”‚    â””â”€ Conversation History (with sender names)              â”‚
â”‚  â”‚    â”‚                                                               â”‚
â”‚  â”‚    â”œâ”€ C. Call LLM                                                â”‚
â”‚  â”‚    â”‚    â”œâ”€ Provider: OpenAI or Groq                              â”‚
â”‚  â”‚    â”‚    â”œâ”€ Format: JSON object                                   â”‚
â”‚  â”‚    â”‚    â””â”€ Returns: {message, actions, reasoning}                â”‚
â”‚  â”‚    â”‚                                                               â”‚
â”‚  â”‚    â””â”€ D. Save Assistant Message                                  â”‚
â”‚  â”‚         â””â”€ session.messages.push({role:"assistant", content})    â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â”œâ”€ 4. Execute Actions                                              â”‚
â”‚  â”‚    â”‚                                                               â”‚
â”‚  â”‚    â””â”€ For each action in aiResult.actions:                       â”‚
â”‚  â”‚         â”œâ”€ executeAction(action, session)                        â”‚
â”‚  â”‚         â”‚    â”œâ”€ Validate action type                             â”‚
â”‚  â”‚         â”‚    â”œâ”€ Execute action logic                             â”‚
â”‚  â”‚         â”‚    â”œâ”€ Modify session state                             â”‚
â”‚  â”‚         â”‚    â””â”€ Return result                                    â”‚
â”‚  â”‚         â”‚                                                          â”‚
â”‚  â”‚         â””â”€ setSession(sessionId, session)  // Save after each    â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â””â”€ 5. Return Response                                              â”‚
â”‚       â””â”€ {response, sessionId, participants, profileUrl}            â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SERVER.JS                                     â”‚
â”‚                   (Broadcast to All)                                 â”‚
â”‚                                                                       â”‚
â”‚  â”œâ”€ Format message with sender name                                 â”‚
â”‚  â”œâ”€ Send to all participants (via Twilio)                           â”‚
â”‚  â””â”€ Include media (if profileUrl present)                           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             USERS                                    â”‚
â”‚                      (All Participants)                              â”‚
â”‚                                                                       â”‚
â”‚   Sarah receives: "Cool! What school did you go to?"                â”‚
â”‚   Mike receives: "Cool! What school did you go to?"                 â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Message Processing Flow

### From User Input to AI Response

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Types       â”‚
â”‚   "I'm 24"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. SESSION LOOKUP                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  getPhoneMapping("+1234567890")                    â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  Redis: GET phone:+1234567890                      â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  Returns: "ABC12"                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  getSessionData("ABC12")                           â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  Redis: GET session:ABC12                          â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  Returns: {sessionId, stage, profileSchema, ...}   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. MESSAGE HISTORY UPDATE                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  session.messages.push({                           â”‚ â”‚
â”‚  â”‚    role: "user",                                   â”‚ â”‚
â”‚  â”‚    content: "I'm 24",                              â”‚ â”‚
â”‚  â”‚    sender: "Sarah",                                â”‚ â”‚
â”‚  â”‚    phoneNumber: "+1234567890"                      â”‚ â”‚
â”‚  â”‚  })                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Redis: SET session:ABC12 {updatedSession}        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. PROMPT CONSTRUCTION                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Base Prompt (static)                              â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚ â”‚
â”‚  â”‚  You're a warm, friendly AI matchmaker...         â”‚ â”‚
â”‚  â”‚  â€¢ Keep messages SHORT: 1-3 sentences              â”‚ â”‚
â”‚  â”‚  â€¢ Use emojis judiciously                          â”‚ â”‚
â”‚  â”‚  ...                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Action Instructions (dynamic)                     â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚ â”‚
â”‚  â”‚  ## CURRENT STATE                                  â”‚ â”‚
â”‚  â”‚  Stage: profile_creation                           â”‚ â”‚
â”‚  â”‚  Participants: Sarah, Mike                         â”‚ â”‚
â”‚  â”‚  Schema Complete: NO                               â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  Missing Fields:                                   â”‚ â”‚
â”‚  â”‚  - age                                             â”‚ â”‚
â”‚  â”‚  - photo                                           â”‚ â”‚
â”‚  â”‚  - bio                                             â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  ## ACTIONS                                        â”‚ â”‚
â”‚  â”‚  1. update_profile_schema                          â”‚ â”‚
â”‚  â”‚  2. update_stage                                   â”‚ â”‚
â”‚  â”‚  ...                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Conversation History (formatted)                  â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚ â”‚
â”‚  â”‚  [                                                 â”‚ â”‚
â”‚  â”‚    {role: "system", content: "...full prompt..."},â”‚ â”‚
â”‚  â”‚    {role: "user", content: "Sarah: I'm 24"}       â”‚ â”‚
â”‚  â”‚  ]                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. LLM CALL                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  callLLM(messages, {                               â”‚ â”‚
â”‚  â”‚    response_format: { type: "json_object" }        â”‚ â”‚
â”‚  â”‚  })                                                â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  OpenAI/Groq API                                   â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  Returns: '{"message":"Cool! What school?", ...}'  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. PARSE RESPONSE                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  parseAIResponse(responseText)                     â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  JSON.parse()                                      â”‚ â”‚
â”‚  â”‚    â†“                                                â”‚ â”‚
â”‚  â”‚  {                                                 â”‚ â”‚
â”‚  â”‚    message: "Cool! What school?",                  â”‚ â”‚
â”‚  â”‚    actions: [                                      â”‚ â”‚
â”‚  â”‚      {type:"update_profile_schema", field:"age",   â”‚ â”‚
â”‚  â”‚       value:24}                                    â”‚ â”‚
â”‚  â”‚    ],                                              â”‚ â”‚
â”‚  â”‚    reasoning: "Stored age from user message"      â”‚ â”‚
â”‚  â”‚  }                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. SAVE ASSISTANT MESSAGE                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  session.messages.push({                           â”‚ â”‚
â”‚  â”‚    role: "assistant",                              â”‚ â”‚
â”‚  â”‚    content: "Cool! What school?"                   â”‚ â”‚
â”‚  â”‚  })                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Redis: SET session:ABC12 {updatedSession}        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. EXECUTE ACTIONS                                       â”‚
â”‚  (See "Action Execution Flow" below)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Action Execution Flow

### How Actions Modify State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Response Parsed                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚  {                                                   â”‚
â”‚    message: "Cool! What school?",                    â”‚
â”‚    actions: [                                        â”‚
â”‚      {type: "update_profile_schema",                 â”‚
â”‚       field: "age", value: 24}                       â”‚
â”‚    ]                                                 â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  For each action:    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ACTION ROUTING                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  executeAction(action, session)               â”‚ â”‚
â”‚  â”‚    â†“                                           â”‚ â”‚
â”‚  â”‚  switch (action.type) {                       â”‚ â”‚
â”‚  â”‚    case "update_profile_schema":              â”‚ â”‚
â”‚  â”‚      â†’ executeUpdateProfileSchema()           â”‚ â”‚
â”‚  â”‚    case "update_stage":                       â”‚ â”‚
â”‚  â”‚      â†’ executeUpdateStage()                   â”‚ â”‚
â”‚  â”‚    case "generate_profile":                   â”‚ â”‚
â”‚  â”‚      â†’ executeGenerateProfile()               â”‚ â”‚
â”‚  â”‚    ...                                        â”‚ â”‚
â”‚  â”‚  }                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. VALIDATION                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  executeUpdateProfileSchema(action, session)  â”‚ â”‚
â”‚  â”‚    â†“                                           â”‚ â”‚
â”‚  â”‚  const { field, value } = action;             â”‚ â”‚
â”‚  â”‚    â†“                                           â”‚ â”‚
â”‚  â”‚  // Check field exists                        â”‚ â”‚
â”‚  â”‚  if (!PROFILE_SCHEMA[field]) {                â”‚ â”‚
â”‚  â”‚    return {success: false, error: "Unknown"}  â”‚ â”‚
â”‚  â”‚  }                                            â”‚ â”‚
â”‚  â”‚    â†“                                           â”‚ â”‚
â”‚  â”‚  // Validate value                            â”‚ â”‚
â”‚  â”‚  if (!fieldDef.validate(value)) {             â”‚ â”‚
â”‚  â”‚    return {success: false, error: "Invalid"}  â”‚ â”‚
â”‚  â”‚  }                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ âœ… Valid
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. STATE MODIFICATION                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  // Update session IN PLACE                   â”‚ â”‚
â”‚  â”‚  session.profileSchema[field] = value;        â”‚ â”‚
â”‚  â”‚                                               â”‚ â”‚
â”‚  â”‚  // Example:                                  â”‚ â”‚
â”‚  â”‚  session.profileSchema["age"] = 24;           â”‚ â”‚
â”‚  â”‚                                               â”‚ â”‚
â”‚  â”‚  // Session now has:                          â”‚ â”‚
â”‚  â”‚  {                                            â”‚ â”‚
â”‚  â”‚    sessionId: "ABC12",                        â”‚ â”‚
â”‚  â”‚    stage: "profile_creation",                 â”‚ â”‚
â”‚  â”‚    profileSchema: {                           â”‚ â”‚
â”‚  â”‚      name: "Sarah",                           â”‚ â”‚
â”‚  â”‚      age: 24,  â† UPDATED                      â”‚ â”‚
â”‚  â”‚      gender: null,                            â”‚ â”‚
â”‚  â”‚      ...                                      â”‚ â”‚
â”‚  â”‚    }                                          â”‚ â”‚
â”‚  â”‚  }                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. LOGGING                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  logger.info('âœ… Profile schema updated', {   â”‚ â”‚
â”‚  â”‚    sessionId: 'ABC12',                        â”‚ â”‚
â”‚  â”‚    field: 'age',                              â”‚ â”‚
â”‚  â”‚    value: 24                                  â”‚ â”‚
â”‚  â”‚  });                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ACTION HISTORY                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  logAction(session, action, result);          â”‚ â”‚
â”‚  â”‚    â†“                                           â”‚ â”‚
â”‚  â”‚  session.actions.push({                       â”‚ â”‚
â”‚  â”‚    timestamp: "2025-10-30T12:00:00Z",         â”‚ â”‚
â”‚  â”‚    type: "update_profile_schema",             â”‚ â”‚
â”‚  â”‚    action: {field: "age", value: 24},         â”‚ â”‚
â”‚  â”‚    result: {success: true},                   â”‚ â”‚
â”‚  â”‚    success: true                              â”‚ â”‚
â”‚  â”‚  });                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. PERSIST TO STORAGE                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  setSession(sessionId, session);              â”‚ â”‚
â”‚  â”‚    â†“                                           â”‚ â”‚
â”‚  â”‚  Redis: SET session:ABC12 {                   â”‚ â”‚
â”‚  â”‚    sessionId: "ABC12",                        â”‚ â”‚
â”‚  â”‚    profileSchema: {age: 24, ...},             â”‚ â”‚
â”‚  â”‚    messages: [...],                           â”‚ â”‚
â”‚  â”‚    actions: [...]                             â”‚ â”‚
â”‚  â”‚  }                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. RETURN RESULT                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  return {                                     â”‚ â”‚
â”‚  â”‚    success: true,                             â”‚ â”‚
â”‚  â”‚    action: 'schema_field_updated',            â”‚ â”‚
â”‚  â”‚    field: 'age'                               â”‚ â”‚
â”‚  â”‚  };                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Stage Transition Flow

### Complete Stage Progression

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INTRODUCTION                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ Welcome user                                       â”‚
â”‚  â€¢ Create session                                     â”‚
â”‚  â€¢ Share join code                                    â”‚
â”‚  â€¢ Ask who profile is for                            â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â”œâ”€ Generate session code (ABC12)                    â”‚
â”‚  â”œâ”€ Send welcome message                             â”‚
â”‚  â””â”€ Transition when user ready                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ update_stage("profile_creation")
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROFILE_CREATION                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ Collect ALL profile fields                        â”‚
â”‚  â€¢ Ask ONE question at a time                        â”‚
â”‚  â€¢ Accept answers from ANY participant               â”‚
â”‚  â€¢ Use update_profile_schema for each field          â”‚
â”‚  â€¢ Monitor missing fields                            â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â”œâ”€ Ask: "How old are you?"                          â”‚
â”‚  â”‚   â†’ update_profile_schema("age", 24)              â”‚
â”‚  â”œâ”€ Ask: "What school?"                              â”‚
â”‚  â”‚   â†’ update_profile_schema("schools", ["Berkeley"])â”‚
â”‚  â”œâ”€ Ask: "What are your interests?"                  â”‚
â”‚  â”‚   â†’ update_profile_schema("interests", [...])     â”‚
â”‚  â””â”€ Continue until all fields collected              â”‚
â”‚                                                       â”‚
â”‚  Exit Condition: ALL required fields filled          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ When schema 100% complete
                      â”‚ update_stage("profile_confirmation")
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROFILE_CONFIRMATION                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ Show profile summary                              â”‚
â”‚  â€¢ Ask for explicit approval                         â”‚
â”‚  â€¢ Send interactive template with buttons            â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â”œâ”€ Display formatted summary                        â”‚
â”‚  â””â”€ send_template_message("profile_confirmation")    â”‚
â”‚       Template buttons:                              â”‚
â”‚       â€¢ "Yes, generate! âœ¨"                           â”‚
â”‚       â€¢ "Make changes"                               â”‚
â”‚       â€¢ "Start over"                                 â”‚
â”‚                                                       â”‚
â”‚  Exit Condition: User approves                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ User clicks "Yes, generate! âœ¨"
                      â”‚ update_stage("profile_generation")
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROFILE_GENERATION                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ Generate profile card image                       â”‚
â”‚  â€¢ Create shareable URL                              â”‚
â”‚  â€¢ Store in session.generatedProfile                 â”‚
â”‚  â€¢ AUTO-TRANSITION (no user wait)                    â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â””â”€ generate_profile()                               â”‚
â”‚       â”œâ”€ Validate min fields (name, age, photo)      â”‚
â”‚       â”œâ”€ Create profile object                       â”‚
â”‚       â”œâ”€ Generate profile URL                        â”‚
â”‚       â””â”€ Auto-transition to profile_review           â”‚
â”‚                                                       â”‚
â”‚  Exit Condition: Automatic                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Automatic
                      â”‚ session.stage = "profile_review"
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROFILE_REVIEW                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ Show generated profile URL                        â”‚
â”‚  â€¢ Allow iteration (change fields â†’ regenerate)      â”‚
â”‚  â€¢ Send interactive template with buttons            â”‚
â”‚  â€¢ Only advance on explicit approval                 â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â”œâ”€ Show profile URL                                 â”‚
â”‚  â””â”€ send_template_message("profile_review")          â”‚
â”‚       Template buttons:                              â”‚
â”‚       â€¢ "Perfect! âœ…"                                 â”‚
â”‚       â€¢ "Change photo ğŸ“¸"                             â”‚
â”‚       â€¢ "Edit details âœï¸"                             â”‚
â”‚                                                       â”‚
â”‚  Iteration Support:                                  â”‚
â”‚  â”œâ”€ User: "Change my bio"                            â”‚
â”‚  â”œâ”€ AI: update_profile_schema("bio", "new text")     â”‚
â”‚  â””â”€ AI: generate_profile() â†’ regenerate              â”‚
â”‚                                                       â”‚
â”‚  Exit Condition: User explicitly approves            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ User clicks "Perfect! âœ…"
                      â”‚ commit_profile()
                      â”‚ update_stage("profile_committed")
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROFILE_COMMITTED                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ Finalize profile                                  â”‚
â”‚  â€¢ IMMEDIATELY execute daily_drop                    â”‚
â”‚  â€¢ Present 2 random demo profiles                    â”‚
â”‚  â€¢ Ask user to vote                                  â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â”œâ”€ commit_profile()                                 â”‚
â”‚  â”‚   â”œâ”€ Mark status as "committed"                   â”‚
â”‚  â”‚   â””â”€ Store timestamp                              â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”œâ”€ daily_drop() [IMMEDIATE]                         â”‚
â”‚  â”‚   â”œâ”€ Select 2 random profiles                     â”‚
â”‚  â”‚   â”œâ”€ Generate catchy descriptions                 â”‚
â”‚  â”‚   â””â”€ Return profile data                          â”‚
â”‚  â”‚                                                    â”‚
â”‚  â””â”€ Present profiles with voting options             â”‚
â”‚       "1. Alex, 25 - [description]"                  â”‚
â”‚       "2. Jamie, 26 - [description]"                 â”‚
â”‚       "Pick: 1, 2, Both, or Neither"                 â”‚
â”‚                                                       â”‚
â”‚  Exit Condition: User votes                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ User picks profiles
                      â”‚ update_stage("fetching_profiles")
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FETCHING_PROFILES                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â€¢ End state                                         â”‚
â”‚  â€¢ Conversation complete                             â”‚
â”‚  â€¢ (Future: real matching logic)                     â”‚
â”‚                                                       â”‚
â”‚  AI Behavior:                                        â”‚
â”‚  â””â”€ "Awesome choice! Sending likes now."             â”‚
â”‚                                                       â”‚
â”‚  Exit Condition: None (terminal state)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## State Management Flow

### How State Flows Through the System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SESSION CREATION                      â”‚
â”‚                                                           â”‚
â”‚  User sends first message                                â”‚
â”‚    â†“                                                      â”‚
â”‚  createSession(phoneNumber, profileName)                 â”‚
â”‚    â”œâ”€ Generate sessionId: "ABC12"                        â”‚
â”‚    â”œâ”€ Create session object:                             â”‚
â”‚    â”‚  {                                                  â”‚
â”‚    â”‚    sessionId: "ABC12",                              â”‚
â”‚    â”‚    stage: "introduction",                           â”‚
â”‚    â”‚    participants: [{phoneNumber, name, role}],       â”‚
â”‚    â”‚    profileSchema: initializeProfileSchema(),        â”‚
â”‚    â”‚    messages: [],                                    â”‚
â”‚    â”‚    actions: []                                      â”‚
â”‚    â”‚  }                                                  â”‚
â”‚    â”œâ”€ Redis: SET session:ABC12 {sessionData}            â”‚
â”‚    â””â”€ Redis: SET phone:+1234567890 "ABC12"              â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               STATE ACCESS (Read)                        â”‚
â”‚                                                           â”‚
â”‚  getSession(phoneNumber)                                 â”‚
â”‚    â”œâ”€ Redis: GET phone:+1234567890 â†’ "ABC12"            â”‚
â”‚    â””â”€ Redis: GET session:ABC12 â†’ {sessionData}          â”‚
â”‚         â†“                                                 â”‚
â”‚         Returns: {                                       â”‚
â”‚           sessionId: "ABC12",                            â”‚
â”‚           stage: "profile_creation",                     â”‚
â”‚           participants: [...],                           â”‚
â”‚           profileSchema: {...},                          â”‚
â”‚           messages: [...],                               â”‚
â”‚           actions: [...]                                 â”‚
â”‚         }                                                â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STATE MODIFICATION                          â”‚
â”‚                                                           â”‚
â”‚  Actions modify session IN PLACE                         â”‚
â”‚    â”œâ”€ session.profileSchema.age = 24                    â”‚
â”‚    â”œâ”€ session.stage = "profile_confirmation"            â”‚
â”‚    â”œâ”€ session.generatedProfile = {...}                  â”‚
â”‚    â””â”€ session.committedProfile = {...}                  â”‚
â”‚                                                           â”‚
â”‚  Messages added to history                               â”‚
â”‚    â””â”€ session.messages.push({role, content, sender})    â”‚
â”‚                                                           â”‚
â”‚  Actions logged                                          â”‚
â”‚    â””â”€ session.actions.push({timestamp, type, result})   â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STATE PERSISTENCE (Write)                   â”‚
â”‚                                                           â”‚
â”‚  setSession(sessionId, sessionData)                      â”‚
â”‚    â”œâ”€ Serialize: JSON.stringify(sessionData)            â”‚
â”‚    â”œâ”€ Redis: SET session:ABC12 {serialized}             â”‚
â”‚    â””â”€ Fallback: sessions.set("ABC12", sessionData)      â”‚
â”‚                                                           â”‚
â”‚  Called after:                                           â”‚
â”‚    â”œâ”€ User message saved                                 â”‚
â”‚    â”œâ”€ AI message saved                                   â”‚
â”‚    â””â”€ Each action execution                              â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STORAGE LAYER                           â”‚
â”‚                                                           â”‚
â”‚  PRIMARY: Redis                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Keys:                                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ session:ABC12 â†’ {full session object}        â”‚  â”‚
â”‚  â”‚  â”œâ”€ session:XYZ34 â†’ {full session object}        â”‚  â”‚
â”‚  â”‚  â”œâ”€ phone:+1234567890 â†’ "ABC12"                  â”‚  â”‚
â”‚  â”‚  â””â”€ phone:+1987654321 â†’ "XYZ34"                  â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  Benefits:                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Persists across server restarts              â”‚  â”‚
â”‚  â”‚  â”œâ”€ Shared across multiple server instances      â”‚  â”‚
â”‚  â”‚  â””â”€ Fast key-value lookups                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  FALLBACK: In-Memory Maps                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  const sessions = new Map();                      â”‚  â”‚
â”‚  â”‚  const phoneToSession = new Map();                â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  Used when:                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Redis connection fails                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Redis not available                           â”‚  â”‚
â”‚  â”‚  â””â”€ Development without Redis                     â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  Limitation:                                      â”‚  â”‚
â”‚  â”‚  â””â”€ Lost on server restart                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Specific Action Flows

### 1. update_profile_schema Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI decides to update age field                â”‚
â”‚                                                 â”‚
â”‚  {                                             â”‚
â”‚    "type": "update_profile_schema",            â”‚
â”‚    "field": "age",                             â”‚
â”‚    "value": 24                                 â”‚
â”‚  }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  executeUpdateProfileSchema(action, session)   â”‚
â”‚                                                 â”‚
â”‚  1. Extract parameters                         â”‚
â”‚     field = "age"                              â”‚
â”‚     value = 24                                 â”‚
â”‚                                                 â”‚
â”‚  2. Validate field exists                      â”‚
â”‚     PROFILE_SCHEMA["age"] âœ… exists            â”‚
â”‚                                                 â”‚
â”‚  3. Validate value type & range                â”‚
â”‚     typeof 24 === "number" âœ…                  â”‚
â”‚     24 >= 18 && 24 <= 100 âœ…                   â”‚
â”‚                                                 â”‚
â”‚  4. Update session state                       â”‚
â”‚     session.profileSchema.age = 24             â”‚
â”‚                                                 â”‚
â”‚  5. Check completion status                    â”‚
â”‚     missingFields = getMissingFields(schema)   â”‚
â”‚     â†’ ["photo", "bio", "interests", ...]       â”‚
â”‚                                                 â”‚
â”‚  6. Log update                                 â”‚
â”‚     logger.info('âœ… Field updated', ...)       â”‚
â”‚                                                 â”‚
â”‚  7. Return success                             â”‚
â”‚     {success: true, field: "age"}              â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Back in handleMessage()                       â”‚
â”‚                                                 â”‚
â”‚  setSession(sessionId, session)                â”‚
â”‚  â”œâ”€ Redis: SET session:ABC12 {updated}        â”‚
â”‚  â””â”€ session.profileSchema.age is now 24       â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. generate_profile Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI decides to generate profile                â”‚
â”‚                                                 â”‚
â”‚  {                                             â”‚
â”‚    "type": "generate_profile"                  â”‚
â”‚  }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  executeGenerateProfile(action, session)       â”‚
â”‚                                                 â”‚
â”‚  1. Validate minimum fields                    â”‚
â”‚     isSchemaCompleteForGeneration(schema)      â”‚
â”‚     â”œâ”€ Check "name" âœ…                         â”‚
â”‚     â”œâ”€ Check "age" âœ…                          â”‚
â”‚     â””â”€ Check "photo" âœ…                        â”‚
â”‚                                                 â”‚
â”‚  2. Create profile object                      â”‚
â”‚     generatedProfile = {                       â”‚
â”‚       id: "profile_ABC12_1730289600000",       â”‚
â”‚       ...session.profileSchema,                â”‚
â”‚       photos: session.data.photos,             â”‚
â”‚       status: "pending_review",                â”‚
â”‚       createdAt: "2025-10-30T12:00:00Z"        â”‚
â”‚     }                                          â”‚
â”‚                                                 â”‚
â”‚  3. Generate profile URL                       â”‚
â”‚     profileUrl =                               â”‚
â”‚       await profileUrlManager.createProfileUrl(â”‚
â”‚         sessionId,                             â”‚
â”‚         generatedProfile,                      â”‚
â”‚         PUBLIC_DOMAIN                          â”‚
â”‚       )                                        â”‚
â”‚     â†’ "https://example.com/p/token123"         â”‚
â”‚                                                 â”‚
â”‚  4. Store profile URL                          â”‚
â”‚     generatedProfile.profileUrl = profileUrl   â”‚
â”‚                                                 â”‚
â”‚  5. Update session                             â”‚
â”‚     session.generatedProfile = generatedProfileâ”‚
â”‚     session.stage = "profile_review"           â”‚
â”‚                                                 â”‚
â”‚  6. Return with URL                            â”‚
â”‚     {                                          â”‚
â”‚       success: true,                           â”‚
â”‚       action: "profile_generated",             â”‚
â”‚       profile: generatedProfile,               â”‚
â”‚       profileUrl: profileUrl                   â”‚
â”‚     }                                          â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Back in handleMessage()                       â”‚
â”‚                                                 â”‚
â”‚  result.profileUrl captured                    â”‚
â”‚  â”œâ”€ Returned to server.js                      â”‚
â”‚  â””â”€ Server sends profile URL to user           â”‚
â”‚                                                 â”‚
â”‚  setSession(sessionId, session)                â”‚
â”‚  â”œâ”€ Redis: SET session:ABC12 {updated}        â”‚
â”‚  â””â”€ session.generatedProfile now exists       â”‚
â”‚  â””â”€ session.stage = "profile_review"           â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. daily_drop Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI decides to do daily drop                   â”‚
â”‚  (MUST be immediately after commit_profile)    â”‚
â”‚                                                 â”‚
â”‚  {                                             â”‚
â”‚    "type": "daily_drop"                        â”‚
â”‚  }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  executeDailyDrop(action, session)             â”‚
â”‚                                                 â”‚
â”‚  1. Validate stage                             â”‚
â”‚     session.stage === "profile_committed" âœ…   â”‚
â”‚                                                 â”‚
â”‚  2. Get all demo profiles                      â”‚
â”‚     allProfiles = demoProfileData.profiles     â”‚
â”‚     â†’ [{name:"Alex", age:25, ...}, ...]        â”‚
â”‚                                                 â”‚
â”‚  3. Select 2 random profiles                   â”‚
â”‚     shuffled = [...allProfiles].sort(random)   â”‚
â”‚     selectedProfiles = shuffled.slice(0, 2)    â”‚
â”‚     â†’ [Alex profile, Jamie profile]            â”‚
â”‚                                                 â”‚
â”‚  4. Generate catchy descriptions               â”‚
â”‚     profilesWithDescriptions = selected.map(p =>â”‚
â”‚       {                                        â”‚
â”‚         name: p.name,                          â”‚
â”‚         age: p.age,                            â”‚
â”‚         profileUrl: getProfileUrl(p),          â”‚
â”‚         description:                           â”‚
â”‚           generateCatchyDescription(p)         â”‚
â”‚       }                                        â”‚
â”‚     )                                          â”‚
â”‚     â†’ [                                        â”‚
â”‚         {name:"Alex", age:25,                  â”‚
â”‚          description:"Loves hiking and dogs",  â”‚
â”‚          url:"..."},                           â”‚
â”‚         {name:"Jamie", age:26,                 â”‚
â”‚          description:"Creative photographer",  â”‚
â”‚          url:"..."}                            â”‚
â”‚       ]                                        â”‚
â”‚                                                 â”‚
â”‚  5. Store in session                           â”‚
â”‚     session.dailyDrops.push({                  â”‚
â”‚       timestamp: "2025-10-30T12:20:00Z",       â”‚
â”‚       profiles: profilesWithDescriptions,      â”‚
â”‚       userChoice: null                         â”‚
â”‚     })                                         â”‚
â”‚                                                 â”‚
â”‚  6. Return profiles to AI                      â”‚
â”‚     {                                          â”‚
â”‚       success: true,                           â”‚
â”‚       action: "daily_drop",                    â”‚
â”‚       profiles: profilesWithDescriptions       â”‚
â”‚     }                                          â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI receives profiles and presents them        â”‚
â”‚                                                 â”‚
â”‚  "alright, daily drop time.                    â”‚
â”‚   I have 2 profiles for you Sarah:             â”‚
â”‚                                                 â”‚
â”‚   1. Alex, 25 - Loves hiking and has a dog     â”‚
â”‚      https://example.com/p/alex                â”‚
â”‚                                                 â”‚
â”‚   2. Jamie, 26 - Creative photographer         â”‚
â”‚      https://example.com/p/jamie               â”‚
â”‚                                                 â”‚
â”‚   okay, what's the move? pick one:             â”‚
â”‚   1. Alex                                      â”‚
â”‚   2. Jamie                                     â”‚
â”‚   3. Both                                      â”‚
â”‚   4. Neither"                                  â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Insights from Diagrams

### 1. Closed Feedback Loop
```
State â†’ Prompt â†’ AI â†’ Actions â†’ Update State â†’ Prompt (next turn)
```
The AI always sees the **current state** in its prompt, creating a closed feedback loop.

### 2. Session as Single Source of Truth
All state lives in the session object:
- Profile data
- Conversation history
- Action history
- Generated artifacts
- Current stage

### 3. Actions Modify State In-Place
Actions don't return new session objectsâ€”they modify the existing session **in place**, then the session is persisted to Redis.

### 4. Stage Progression is Linear
Stages progress forward through a defined flow. Some stages auto-transition (profile_generation), others wait for user approval.

### 5. Multi-Action Sequences
The AI can perform multiple actions in one response, and they execute **sequentially**.

### 6. Validation at Multiple Layers
1. **Prompt**: AI learns what's valid
2. **Action Router**: Checks action type exists
3. **Action Executor**: Validates parameters and state
4. **Schema Validator**: Validates field values

---

## Summary

These diagrams show how:
- **User messages** flow through the system
- **AI prompts** are dynamically constructed from state
- **Actions** modify state in structured ways
- **State** persists across turns
- **Stages** control the conversation flow
- **Multiple components** work together seamlessly

The system is designed for **extensibility**â€”adding new actions, stages, or fields follows clear patterns shown in these flows.

